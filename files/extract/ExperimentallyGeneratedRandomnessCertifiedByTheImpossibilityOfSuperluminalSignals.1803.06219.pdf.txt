


















































Experimentally Generated Randomness Certified by
the Impossibility of Superluminal Signals

Peter Bierhorst,1∗ Emanuel Knill,1,6 Scott Glancy,1 Yanbao Zhang,1†

Alan Mink,2,3 Stephen Jordan,2 Andrea Rommal,4 Yi-Kai Liu,2

Bradley Christensen,5 Sae Woo Nam,1 Martin J. Stevens,1 Lynden K. Shalm1

1National Institute of Standards and Technology, Boulder 80305, CO, USA
2 National Institute of Standards and Technology, Gaithersburg 20899, MD, USA

3 Theiss Research, La Jolla, CA, 92037, USA
4 Muhlenberg College, Allentown, PA, 18104, USA

5 Department of Physics, University of Wisconsin, Madison, WI, 53706, USA
6Center for Theory of Quantum Matter, University of Colorado, Boulder, Colorado 80309, USA
†Present address: NTT Basic Research Laboratories and NTT Research Center for Theoretical

Quantum Physics, NTT Corporation, 3-1 Morinosato-Wakamiya, Atsugi, Kanagawa 243-0198, Japan
∗ E-mail: peter.bierhorst@nist.gov

From dice to modern complex circuits, there have been many attempts to build increas-
ingly better devices to generate random numbers. Today, randomness is fundamental to
security and cryptographic systems, as well as safeguarding privacy. A key challenge
with random number generators is that it is hard to ensure that their outputs are unpre-
dictable [1–3]. For a random number generator based on a physical process, such as a
noisy classical system or an elementary quantum measurement, a detailed model describ-
ing the underlying physics is required to assert unpredictability. Such a model must make
a number of assumptions that may not be valid, thereby compromising the integrity of the
device. However, it is possible to exploit the phenomenon of quantum nonlocality with a
loophole-free Bell test to build a random number generator that can produce output that
is unpredictable to any adversary limited only by general physical principles [1–11]. With
recent technological developments, it is now possible to carry out such a loophole-free Bell
test [12–14]. Here we present certified randomness obtained from a photonic Bell experi-
ment and extract 1024 random bits uniform to within 10−12. These random bits could not
have been predicted within any physical theory that prohibits superluminal signaling and
allows one to make independent measurement choices. To certify and quantify the ran-

1

ar
X

iv
:1

80
3.

06
21

9v
1 

 [
qu

an
t-

ph
] 

 2
2 

Fe
b 

20
18



domness, we describe a new protocol that is optimized for apparatuses characterized by
a low per-trial violation of Bell inequalities. We thus enlisted an experimental result that
fundamentally challenges the notion of determinism to build a system that can increase
trust in random sources. In the future, random number generators based on loophole-
free Bell tests may play a role in increasing the security and trust of our cryptographic
systems and infrastructure.

The search for certifiably unpredictable random number generators is motivated by appli-
cations, such as secure communication, for which the predictability of pseudorandom strings
make them unsuitable. Private randomness is required to initiate and authenticate virtually every
secure communication [15], and public randomness from randomness beacons can be used for
public certification and resource distribution in many settings [16]. To certify randomness, one
can perform an experiment known as a Bell test [17], which in its simplest form performs mea-
surements on an entangled system located in two physically separated measurement stations,
with each station choosing between two types of measurements. After multiple experimental
trials with varying measurement choices, if the measurement data violates conditions known as
“Bell inequalities,” then the data can be certified to contain randomness under weak assump-
tions.

Our randomness generation employs a “loophole-free” Bell test, which notably is character-
ized by high detection efficiency and space-like separation of the measurement stations during
each experimental trial. The bits are unpredictable assuming that (1) the choices of measure-
ment settings are independent of the experimental devices and pre-existing classical informa-
tion about them and (2) in each experimental trial, the measurement outcomes at each station
are independent of the settings choices at the other station. The first assumption is ultimately
untestable, but the premise that it is possible to choose measurement settings independently of
a system being measured is often tacitly invoked in the interpretation of many scientific exper-
iments and laws of physics [18]. The second assumption can only be violated if one admits a
theory that permits sending signals faster than the speed of light, given our trust that the space-
like separation of the relevant events in the experiment is accurately verified by the timing
electronics and that results are final when recorded. We also trust that the classical computing
equipment used to process the data operates according to specification.

Under the above assumptions, the output randomness is certified to be unpredictable with
respect to a real or hypothetical actor “Eve” in possession of the pre-existing classical informa-
tion, physically isolated from the devices while they are under our control, and without access
to data produced during the protocol. The bits remain unpredictable to Eve if she learns the set-
tings at any time after her last interaction with the devices. If the devices are trusted, which is
reasonable if we built them, then this may be well before the start of the protocol, in which case
the settings can come from public randomness [2,10]. In particular, one can use an existing pub-
lic randomness source, such as the NIST random beacon [16], to generate much needed private
randomness as output. Since the assumptions do not constrain the specific physical realization
of the devices and do not require specific states or measurements, they implement a “device-
independent” framework [19] which allows an individual user to assure security with minimal

2



assumptions about the devices. If Eve has quantum memory, it is possible to ensure that Eve’s
side information is effectively classical by verifying that the devices have no long-term quantum
memory of past interactions with Eve. While this introduces weak device-dependence, for the
foreseeable future this verification task is comparable to that required to enforce the absence of
communication from the devices to Eve.

The only previous experimental production of certified randomness from Bell test data was
reported in the ground-breaking paper by Pironio et al. [5]. Their Bell test was implemented
with ions in two separate ion-traps, closing the detection loophole [20] but without space-like
separation. Indeed, Bell tests achieving space-like separation without other experimental loop-
holes have been performed only recently [12–14, 21]. Under more restrictive assumptions than
ours, the maximum amount of randomness in principle available in the data of Pironio et al.
was quantified as 42 bits with an error parameter of 0.01, but they did not extract a uniformly
distributed bit string from their data. Pironio et al. argue that any interaction between measure-
ment stations in their experiment is negligible, because they are located in separate ion-traps,
each in its own vacuum chamber. However, any shielding between the stations is necessarily
incomplete; for example they must have an open quantum channel to establish entanglement.
Mundane physical effects can allow local-realistic systems to appear to violate Bell inequal-
ities when shielding is incomplete. Relying instead on the impossibility of faster-than-light
communication provides stronger assurance of the unpredictability of the randomness.

We generated randomness using an improved version of the loophole-free Bell test reported
in Ref. [13]. Five new data sets were collected, with the best-performing data set yielding 1024
new random bits uniform to within 10−12. We also obtained 256 random bits from the main data
set analyzed in Ref. [13], albeit only uniform to within 0.02. The experiment, illustrated in Fig.
1, consisted of a source of entangled photons and two measurement stations named “Alice” and
“Bob”. During an experimental trial, at each station a random choice was made between two
measurement settings labeled 0 and 1, after which a measurement outcome of detection (+) or
nondetection (0) was recorded. Each station’s implementation of the measurement setting was
space-like separated from the other station’s measurement event, and no postselection was em-
ployed in collecting the data. See the Methods section for details. For trial i, we model Alice’s
settings choices with the random variable Xi and Bob’s with Yi, both of which take values in
the set {0, 1}. Alice’s and Bob’s measurement outcome random variables are respectively Ai
and Bi, both of which take values in the set {+, 0}. When referring to a generic single trial, we
omit indices. With this notation, a general Bell inequality for our scenario can be expressed in
the form [22] ∑

abxy

sabxyP(A = a,B = b|X = x, Y = y) ≤ β, (1)

where the sabxy are fixed real coefficients indexed by a, b, x, y that range over all possible values
of A,B,X, Y . The upper bound β is required to be satisfied whenever the settings-conditional
outcome probabilities are induced by a model satisfying “local realism” (LR). LR distributions,
which cannot be certified to contain randomness, are those for which P(A = a,B = b|X =
x, Y = y) is of the form

∑
λ P(A = a|X = x,Λ = λ)P(B = b|Y = y,Λ = λ)P(Λ = λ) for

3



a random variable Λ representing local hidden variables. The Bell inequality is non-trivial if
there exists a quantum-realizable distribution that can violate the bound β.

It has long been known that experimental violations of Bell inequalities such as Eq. 1 indi-
cate the presence of randomness in the data. To quantify randomness with respect to Eve, we
represent Eve’s initial classical information by a random variable E. We formalize the assump-
tion that measurement settings can be generated independently of the system being measured
and Eve’s information with the following condition:

P(Xi = x, Yi = y|E = e, pasti) = P(Xi = x, Yi = y) =
1

4
∀x, y, e, (2)

where pasti represents events in the past of the i’th trial, specifically including the trial settings
and outcomes for trial 1 through i − 1. Our other assumption, that measurement outcomes are
independent of remote measurement choices, is formalized as follows:

P(Ai = a|Xi = x, Yi = y, E = e, pasti) = P(Ai = a|Xi = x,E = e, pasti)
P(Bi = b|Xi = x, Yi = y, E = e, pasti) = P(Bi = b|Yi = y, E = e, pasti) ∀x, y, e. (3)

These equations are commonly referred to as the “non-signaling” assumptions, although they
are often stated without the conditionals E and pasti. Our space-like separation of settings and
remote measurements provide assurance that the experiment obeys Eqs. 3. We remark that if one
assumes the measured systems obey quantum physics, stronger constraints are possible [23,24].

Given Eqs. 2 and 3, our protocol produces random bits in two sequential parts. For the first
part, “entropy production”, we implement n trials of the Bell test, from which we compute a
statistic V related to a Bell inequality (Eq. 1). V quantifies the Bell violation and determines
whether or not the protocol passes or aborts. If the protocol passes, we certify an amount of
randomness in the outcome string even conditioned on the setting string and E. In the second
part, “extraction,” we process the outcome string into a shorter string of bits whose distribution
is close to uniform. We used our customized implementation of the Trevisan extractor [25]
derived from the framework of Mauerer, Portmann and Scholz [26] and the associated open
source code. We call this the TMPS algorithm, see Supplementary Information (SI) S.4 for
details.

We applied a new method of certifying the amount of randomness in Bell tests. Previous
methods for related models with various sets of assumptions [2–8, 27–29] are ineffective in
our experimental regime (SI S.7), which is characterized by a small per-trial violation of Bell
inequalities. Other recent works that explore how to effectively certify randomness from a wider
range of experimental regimes assume that measured states are independent and identically
distributed (i.i.d.) or that the regime is asymptotic [9–11, 30]. Our method, which does not
require these assumptions, builds on the Prediction-Based Ratio (PBR) method for rejecting LR
[31]. Applying this method to training data (see below), we obtain a real-valued “Bell function”
T with arguments A,B,X, Y that satisfies T (A,B,X, Y ) > 0 with expectation E(T ) ≤ 1
for any LR distribution satisfying Eq. 2. From T we determine the maximum value 1 + m

4



of E(T ) over all distributions satisfying Eqs. 2 and 3, where we require that m > 0. Such
a function T induces a Bell inequality (Eq. 1) with β = 4 and sabxy = T (a, b, x, y). Define
Ti = T (Ai, Bi, Xi, Yi) and V =

∏n
i=1 Ti. If the experimenter observes a value of V larger than

1, this indicates a violation of the Bell inequality and the presence of randomness in the data.
The randomness is quantified by the following theorem, proven in the SI S.2. Below, we denote
all of the settings of both stations with XY = X1Y1X2Y2...XnYn, and other sequences such as
AB and ABXY are similarly interleaved over n trials.

Entropy Production Theorem. Suppose T is a Bell function satisfying the above conditions.
Then in an experiment of n trials obeying Eqs. 2 and 3, the following inequality holds for all
�p ∈ (0, 1) and vthresh satisfying 1 ≤ vthresh ≤ (1 + (3/2)m)n�−1p :

Pe (Pe(AB|XY) > δ AND V ≥ vthresh) ≤ �p (4)

where δ = [1+(1− n√�pvthresh)/(2m)]n and Pe denotes the probability distribution conditioned
on the event {E = e}, where e is arbitrary. The expression Pe(AB|XY) denotes the random
variable that takes the value Pe(AB = ab|XY = xy) when ABXY takes the value abxy.

In words, the theorem says that with high probability, if V is at least as large as vthresh, then the
output AB is unpredictable, in the sense that no individual outcome {AB = ab} occurs with
probability higher than δ, even given the information {XYE = xye}. The theorem supports a
protocol that aborts if V takes a value less than vthresh, and passes otherwise. If the probability
of passing were 1, then − log2(δ) would be a so-called “smooth min-entropy”, a quantity that
characterizes the number of uniform bits of randomness that are in principle available in AB
[32, 33]. We show in the SI S.3 that for constant �p, − log2(δ) is proportional to the number
of trials. How many bits we can actually extract depends on �fin, the final output’s maximum
allowed distance from uniform. We also show in the SI that the Entropy Production Theorem
can still be proved if Eq. 2 is weakened so that settings probabilities need not be known but are
constrained to be within α of 1/4 with α < 1/4, while still being conditionally independent
of earlier outcomes given earlier settings. Such a weakening is relevant for experiments [12–
14] that use physical random number generators to choose the settings, for which the settings
probabilities cannot be known exactly.

To extract the available randomness in AB, we use the TMPS algorithm to obtain an extrac-
tor, specifically a function Ext that takes as input the string AB and a length d “seed” bit string
S, where S is uniform and independent of ABXY. Its output is a length t bit string. S can be
obtained from d additional instances of the random variables Xi, so Eq. 2 ensures the needed
independence and uniformity conditions on S. In order for the output to be within a distance �fin
of uniform independent of XY and E, the entropy production and extractor parameters must
satisfy the constraints given in the next theorem, proven in the SI S.5. In the statement of the
theorem, the measure of distance used is the “total variation (TV) distance,” expressed by the
left side of Eq. 6, and “pass” is the event that V exceeds vthresh.

5



Protocol Soundness Theorem. Let 0 < �ext, κ < 1. Suppose that P(pass) ≥ κ and suppose that
that the protocol parameters satisfy

t+ 4 log2 t ≤ − log2 δ + log2 κ+ 5 log2 �ext − 11. (5)

Then the output U = Ext(AB,S) of the function obtained by the TMPS algorithm satisfies

1

2

∑
u,xyse

∣∣∣P(U = u,XYSE = xyse|pass)−Punif(U = u)P(XYE = xye|pass)Punif(S = s)∣∣∣
≤ �p/P(pass) + �ext, (6)

where Punif denotes the uniform probability distribution.

The number of seed bits d required satisfies d = O(log(t) log(nt/�ext)2), and SI S.4 gives an
explicit bound.

The theorem provides several options for quantifying the uniformity of the randomness pro-
duced. A goal is for the protocol to be nearly indistinguishable according to TV distance from
an ideal protocol, where in an ideal protocol the randomness is perfectly uniform conditional on
passing. For this, the ideal protocol can be chosen to have the same probability of passing with
behavior matching that of the real protocol when aborting. The theorem implies that the uncon-
ditional distribution of the protocol is within TV distance max(�p + �ext, κ) of that of an ideal
protocol (SI S.5). For this distance, if the probability of passing is comparable to κ, then the
conditional TV distance from uniform, given in Eq. 6, could be large. It is desirable that even
for the worst case probability of passing, the conditional TV distance be small. Accordingly, we
quantify the uniformity for our implementation with �fin = max(�p/κ + �ext, κ). Then, for any
probability of passing greater than �fin, conditionally on passing, the TV distance from uniform
is at most �fin.

We applied our protocol to five data sets using the setup based on that described in Ref. [13]
with improvements described in the Methods section. Each data set was collected in five to ten
minutes, improving on the approximately one month duration of data acquisition reported in
Ref. [5]. Before starting the protocol, we set aside the first 5 × 106 trials of each data set as
training data, which we used to choose parameters needed by the protocol. With the training
data removed, the number n of trials used by the protocol was between 2.5× 107 and 5.5× 107
for each data set. We used the training data to determine a Bell function T with statistically
strong violation of LR on the training data according to the PBR method [31]; see SI S.3.
The function T obtained for the fifth data set, which was longest in duration and produced the
most randomness, is given in Table 1 as an example. We computed thresholds vthresh so that a
sample of n i.i.d. trials from the distribution inferred from the training data would have a high
probability for exceeding vthresh.

For the fifth data set, a sample of n i.i.d. trials from the distribution inferred from the training
data would have approximately 0.99 probability of exceeding a threshold of vthresh = 1.5×1032.
This would allow the extraction of 1024 bits uniform to within �fin = 10−12, using �p = κ2 =

6



Table 1: Bell function T obtained from Data Set 5. We used a numerical method based on
maximum likelihood to infer a non-signaling distribution based on the raw counts of the training
trials, namely the first 5×106 trials. We then determined the function T that maximizes E(lnT )
according to this distribution, subject to the constraints that E(T )LR ≤ 1 for all LR distributions
and T (0, 0, x, y) = 1 for all x, y. The latter constraint improves the signal-to-noise for our
data. The function T yields m = 0.0100425, and E(T ) = 1.000003931 for the non-signaling
distribution inferred from the training data. One can also interpret the numbers below as the
coefficients sabxy in Eq. 1, which defines a Bell inequality with β = 4. The values of T are
rounded down at the tenth digit.

ab = ++ ab = +0 ab = 0+ ab = 00
xy = 00 1.0243556353 0.9704647804 0.9735507658 1
xy = 01 1.0256127409 0.9491951243 0.9960775334 1
xy = 10 1.0227274988 0.9962782754 0.9461091383 1
xy = 11 0.9273040563 1.0037217225 1.0039224645 1

9.025 × 10−25 and �ext = 5 × 10−14. These values were chosen based on a numerical study
of the constraints on the number t of bits extracted for fixed values of �fin = 10−12. Running
the protocol on the remaining 55, 110, 210 trials with these parameters, the product

∏n
i=1 Ti

exceeded vthresh, and so the protocol passed. Applying the extractor to the resulting output
string AB with a seed of length d = 315, 844, we extracted 1024 bits, certified to be uniform to
within 10−12, the first ten of which are 1110001001. Figure 2 displays the extractable bits for
alternative choices of �fin for all five data sets.

We also applied the protocol to data from the experiment of Ref. [13]. This experiment was
more conservative in taking additional measures to ensure that it was loophole-free, including
space-like separation of the measurement choices from both the downconversion event and
the remote measurement outcomes. We extracted 256 bits at �fin = 0.02 from the best data
set, XOR 3, reported in Ref. [13]. The distance from an ideal protocol as explained after the
Protocol Soundness Theorem was 4.00 × 10−4, without accounting for possible bias in the
random source used. For details see SI S.6.

For the data set producing 1024 new near random bits, our protocol used 1.10 × 108 uni-
form bits to choose the settings and 3.16 × 105 uniform bits to choose the seed. Because the
extractor used is a “strong” extractor, the seed bits are still uniform conditional on passing, so
they can be recovered at the end of the protocol for uses elsewhere. This is not the case for
the settings-choice bits because the probability of passing is less than 1. To reduce the entropy
used for the settings, our protocol can be modified to use highly biased settings choices [5]. Re-
ducing settings entropy is not a priority if the settings and seed bits come from a public source
of randomness, in which case the output bits can still be certified to be unknown to external
observers such as Eve and the current protocol is an effective method for private randomness
generation [2, 10].

For future work, we hope to take advantage of the adaptive capabilities of the Entropy

7



Production Theorem (SI S.2) to dynamically compensate for experimental drift during run time.
In view of advances toward practical quantum computing it is desirable to study the protocol in
the presence of quantum side information, which may require more conservative randomness
generation. We also look forward to technical improvements in experimental equipment for
larger violation and higher trial rates. These will enable faster generation of random bits with
lower error and support the use of biased settings choices.

Existing randomness generation systems rely on detailed assumptions about the specific
physics underlying the devices. With the advent of loophole-free Bell tests, it is now possi-
ble to build quantum devices that exploit quantum nonlocality to remove many of the device-
dependent assumptions in current technological implementations. Our device-independent ran-
dom number generator is an example of such a system. Such generators can provide the best
method currently known for physically producing randomness, thereby improving the security
of a wide range of applications.

Methods We used polarization-entangled photons generated by a nonlinear crystal pumped by
a pulsed, picosecond laser at approximately 775 nm in a configuration similar to that reported
in Ref. [13], but with several improvements to increase the rate of randomness extraction. The
laser’s repetition rate was 79.3 MHz, and each pulse that entered the crystal had a probability of
≈ 0.003 of creating an entangled photon pair in the state |ψ〉 ≈ 0.982 |HH〉+ 0.191 |V V 〉 at a
center wavelength of 1550 nm. By pumping the crystal with approximately five times as much
power, and using a 20 mm long crystal, we were able to substantially increase the per-pulse
probability of generating a downconversion event compared with Ref. [13] while maintaining
similar overall system efficiencies. The two entangled photons from each pair were separately
sent to one of the two measurement stations (187±1) m apart. At Alice and Bob, a Pockels cell
and polarizer combined to allow the rapid switching of measurement bases and measurement of
the polarization state of the incoming photons. Each Pockels cell operated at a rate of 100 kHz,
allowing us to perform 100,000 trials per second (the driver electronics on the Pockels cells sets
this rate). The photons were then detected using fiber-coupled superconducting single-photon
nanowire detectors, with Bob’s detector operating at approximately 90% efficiency and Alice’s
detector operating with approximately 92% efficiency [34]. For this experiment, the total sym-
metric system heralding efficiency was (75.5 ± 0.5%), which is above the 71.5% threshold
required to close the detection-loophole for our experimental configuration after accounting for
unwanted background counts at our detectors and slight imperfections in our state preparation
and measurements components.

With this configuration, Bob completed his measurement (294.4 ± 3.7) ns before a hypo-
thetical switching signal travelling at light speed from Alice’s Pockels cell could arrive at his
station. Similarly, Alice completed her measurement (424.2±3.7) ns before such a signal from
Bob’s Pockels cell could arrive at her location. Each trial’s outcome values were obtained by
aggregating the photon detection or non-detection events from several short time intervals last-
ing 1024 ps, each of which is timed to correspond to one pulse of the pump laser. If any photons
were detected in the short intervals, the outcome is “+”, and if no photons were detected, the

8



outcome is “0”. The experiment of Ref. [13] used at most 7 short intervals, but here we were
able to include 14 intervals while maintaining space-like separation, which further increased
the probability of observing a photon during each trial. For demonstration purposes, Alice
and Bob each used Python’s random.py module with the default generator (the Mersenne
twister) to pick their settings at each trial. This pseudorandom source is predictable, and for
secure applications of the protocol in an adversarial scenario, such as if the photon pair source
or measurement devices are obtained from an untrusted provider, settings choices must be based
on random sources that are effectively not predictable. However, based on our knowledge of
device construction, we know that our devices have no physical resources for predicting pseudo-
random numbers and expect that measurement settings were effectively independent of relevant
devices so that Eqs. 2 and 3 still hold. We remark that the settings choices for the XOR 3 data
set were based on physical random sources.

With the improved detection efficiency, the higher per-trial probability of for Alice and Bob
to detect a photon, and a higher signal-to-background counts ratio we are able to improve both
the magnitude of our Bell violation as well as reduce the number of trials required to achieve a
statistically significant violation by an order of magnitude.

References
[1] Acı́n, A. & Masanes, L. Certified randomness in quantum physics. Nature 540, 213

(2016).

[2] Pironio, S. & Massar, S. Security of practical private randomness generation. Phys. Rev.
A 87, 012336 (2013).

[3] Miller, C. & Shi, Y. Robust protocols for securely expanding randomness and distributing
keys using untrusted quantum devices. J. ACM 63, 33:1–33:63 (2016).

[4] Colbeck, R. & Kent, A. Private randomness expansion with untrusted devices. J. Phys. A:
Math. Theor. 44, 095305 (2011).

[5] Pironio, S. et al. Random numbers certified by Bell’s theorem. Nature 464, 1021–4 (2010).

[6] Vazirani, U. & Vidick, T. Certifiable quantum dice - or, exponential randomness ex-
pansion. In STOC’12 Proceedings of the 44th Annual ACM Symposium on Theory of
Computing, 61 (2012).

[7] Fehr, S., Gelles, R. & Schaffner, C. Security and composability of randomness expansion
from Bell inequalities. Phys. Rev. A 87, 012335 (2013).

[8] Chung, K.-M., Shi, Y. & Wu, X. Physical randomness extractors: Generating random
numbers with minimal assumptions (2014). ArXiv:1402.4797 [quant-ph].

9



[9] Nieto-Silleras, O., Pironio, S. & Silman, J. Using complete measurement statistics for
optimal device-independent randomness evaluation. New Journal of Physics 16, 013035
(2014).

[10] Bancal, J.-D., Sheridan, L. & Scarani, V. More randomness from the same data. New
Journal of Physics 16, 033011 (2014).

[11] Thinh, L., de la Torre, G., Bancal, J.-D., Pironio, P. & Scarani, V. Randomness in post-
selected events. New Journal of Physics 18, 035007 (2016).

[12] Hensen, B. et al. Loophole-free Bell inequality violation using electron spins separated
by 1.3 km. Nature 526, 682 (2015).

[13] Shalm, L. K. et al. Strong loophole-free test of local realism. Phys. Rev. Lett. 115, 250402
(2015).

[14] Giustina, M. et al. Significant-loophole-free test of bell’s theorem with entangled photons.
Phys. Rev. Lett. 115, 250401 (2015).

[15] Paar, C. & Pelzl, J. Understanding Crypotgraphy (Springer-Verlag Berlin Heidelberg,
New York, 2010).

[16] Fischer, M. J., Iorga, M. & Peralta, R. A public randomness service. In SECRYPT 2011,
434–38 (2011).

[17] Bell, J. On the Einstein Podolsky Rosen paradox. Physics 1, 195–200 (1964).

[18] Bell, J. S., Shimony, A., Horne, M. A. & Clauser, J. F. An exchange on local beables.
Dialectica 39, 85–96 (1985).

[19] Colbeck, R. Quantum and Relativistic Protocols for Secure Multi-Party Computation.
Ph.D. thesis, University of Cambridge (2007).

[20] Pearle, P. M. Hidden-variable example based upon data rejection. Phys. Rev. D 2, 1418–
1425 (1970).

[21] Rosenfeld, W. et al. Event-ready Bell test using entangled atoms simultaneously closing
detection and locality loopholes. Phys. Rev. Lett. 119, 010402 (2017).

[22] Brunner, N., Cavalcanti, D., Pironio, S., Scarani, V. & Wehner, S. Bell nonlocality. Rev.
Mod. Phys. 86, 419–78 (2014).

[23] Cirel’son, B. S. Quantum generalizations of Bell’s inequality. Lett. Math. Phys. 4, 93–100
(1980).

10



[24] Navascués, M., Pironio, S. & Acı́n, A. A convergent hierarchy of semidefinite programs
characterizing the set of quantum correlations. New Journal of Physics 10, 073013 (2008).

[25] Trevisan, L. Extractors and pseudorandom generators. J. ACM 48, 860–79 (2001).

[26] Mauerer, W., Portmann, C. & Scholz, V. A modular framework for randomness extraction
based on Trevisan’s construction (2012). ArXiv:1212.0520 [cs.IT].

[27] Coudron, M. & Yuen, H. Infinite randomness expansion with a constant number of de-
vices. In STOC’14 Proceedings of the 46th Annual ACM Symposium on Theory of Com-
puting, 427–36 (2014).

[28] Dupuis, F., Fawzi, O. & Renner, R. Entropy accumulation (2016). ArXiv:1607.01796
[quant-ph].

[29] Arnon-Friedman, R., Renner, R. & Vidick, T. Simple and tight device-independent secu-
rity proofs (2016). ArXiv:1607.01797 [quant-ph].

[30] Miller, C. & Shi, Y. Universal security for randomness expansion from the spot-checking
protocol (2014). ArXiv:1411.6608 [quant-ph].

[31] Zhang, Y., Glancy, S. & Knill, E. Asymptotically optimal data analysis for rejecting local
realism. Phys. Rev. A 84, 062118 (2011).

[32] Trevisan, L. & Vadhan, S. Extracting randomness from samplable distributions. In FOCS
’00 Proceedings of the 41st Annual Symposium on Foundations of Computer Science
(IEEE Computer Society, Washington, DC, 2000).

[33] Renner, R. Security of Quantum Key Distribution. Ph.D. thesis, ETH, ETH, Switzerland
(2006). ArXiv:quant-ph/0512258.

[34] Marsili, F. et al. Detecting single infrared photons with 93% system efficiency. Nature
Photonics 7, 210–214 (2013).

Acknowledgments We thank Carl Miller and Kevin Coakley for comments on the manuscript.
A.M. acknowledges financial support through NIST grant 70NANB16H207.

Author Contributions P.B. led the project and implemented the protocol. P.B., E.K., S.G. and
Y.Z. developed the protocol theory. A.M., S.J., A.R. and Y.-K. L. were responsible for extractor
theory and implementation. B.C., S.W.N., M.J.S. and L.K.S. collected and interpreted the data.
PB., E.K., S.G. and L.K.S. wrote the manuscript.

Author Information This work is a contribution of the National Institute of Standards and
Technology and is not subject to U.S. copyright. The authors declare no competing finan-
cial interests. Correspondence and requests for materials should be addressed to P.B. (pe-
ter.bierhorst@nist.gov).

11



Figure 1: The locations of the Source (S), Alice (A) and Bob (B). Each trial, the source
lab produces a pair of photons in the non-maximally polarization-entangled state |ψ〉 ≈
0.982 |HH〉 + 0.191 |V V 〉, where H (V ) denotes horizontal (vertical) polarization. One pho-
ton is sent to Alice’s lab while the other is sent to Bob’s lab to be measured as shown in inset
(b). Alice’s computed optimal polarization measurement angles, relative to a vertical polarizer,
are {a = −3.7o, a′ = 23.6o} while Bob’s are {b = 3.7o, b′ = −23.6o}. Both Alice and Bob
use a fast Pockels cell (PC), two half-waveplates (HWP), a quarter-waveplates (QWP), and a
polarizing beam displacer to switch between their respective polarization measurements. A
pseudorandom number generator (RNG) governs the choice of each measurement setting every
trial. After passing through the polarization optics, the photons are coupled into a single-mode
fiber and sent to a superconducting nanowire detector. The signals from the detector are then
amplified and sent to a time tagger where their arrival times are recorded and the measurement
outcome is fixed. A 10 MHz oscillator keeps Alice and Bob’s timetagger clocks locked. Alice
and Bob are (187 ± 1) m apart. At this distance, Alice’s measurement outcome is space-like
separated from the triggering of Bob’s Pockels cell and vice-versa.

12



ǫ
fin

10-16 10-14 10-12 10-10 10-8 10-6 10-4 10-2 100

E
xt

ra
ct

ab
le

 B
its

1000

2000

3000

4000

5000

6000

Set 1
Set 2
Set 3
Set 4
Set 5

Figure 2: Extractable bits as a function of error. The figure shows the tradeoff between final
error �fin and number of extractable bits t for values of vthresh pre-chosen to yield estimated
passing probabilities exceeding 95%. These thresholds were met in each case. For all data
sets we set �p = κ2 = (0.95 �fin)2 and �ext = 0.05 �fin, a split that was generally found to be
near-optimal when numerically maximizing t in Eq. 5 for fixed values of �fin.

13



Experimentally Generated Randomness Certified
by the Impossibility of Superluminal Signals

(Supplementary Information)
Peter Bierhorst, Emanuel Knill, Scott Glancy, Yanbao Zhang,

Alan Mink, Stephen Jordan, Andrea Rommal, Yi-Kai Liu,
Bradley Christensen, Sae Woo Nam, Martin J. Stevens, Lynden K. Shalm

After preliminaries to establish notation and summarize needed properties of total variation
distance and non-signaling distributions in S.1, we give the proof of the Entropy Production
Theorem in S.2. We explain how we chose the Bell function T , whose product determines
whether we obtained the desired amount of randomness, in S.3. We then discuss the parameters
of the extractors obtained by the TMPS algorithm (S.4) and prove the Protocol Soundness The-
orem (S.5). Details on how we analyzed the experimental data sets are in S.6. Justification for
our claim that previous methods do not obtain any randomness from our low per-trial-violation
data is given in S.7.

S.1 Preliminaries
We use the standard convention that capital letters refer to random variables (RVs) and corre-
sponding lowercase letters refer to values that the RVs can take. All our RVs take values in finite
sets such as the set of bit strings of a given length or a finite subset of the reals, so that our RVs
can be viewed as functions on a finite probability space. We usually just work with the induced
joint distributions on the sets of values assumed by the RVs. When working with conditional
probabilities, we implicitly exclude points where the conditioner has zero probability whenever
appropriate. We use P(. . .) to denote probabilities and E(. . .) for expectations. Inside P(. . .)
and when used as conditioners, logical statements involving RVs are event specifications to be
interpreted as the event for which the statement is true. For example, P(R > δ) is equivalent to
P({ω : R(ω) > δ}), which is the probability of the event that the RV R takes a value greater
than δ. The same convention applies when denoting events with {. . .}. For example, the event
in the previous example is written as {R > δ}. While formally events are sets, we commonly
use logical language to describe relationships between events. For example, the statement that
{R > δ} implies {S > �} means that as a set, {R > δ} is contained in {S > �}. When
they appear outside the the mentioned contexts, logical statements are constraints on RVs. For
example, the statement R > δ means that all values r of R satisfy r > δ, or equivalently, for all
ω, R(ω) > δ. As usual, comma separated statements are combined conjunctively (with “and”).
(In the main text, for clarity, we have used an explicit “AND” for this purpose.)

If there are free RVs inside P(. . .) or in the conditioner of E(. . . | . . .) outside event specifi-
cations, the final expression defines a new RV as a function of the free RVs. An example from
the Entropy Production Theorem is the expression P(AB|XY), which defines the RV that takes
the value P(AB = ab|XY = xy) when the event {ABXY = abxy} occurs. Values of RVs
such as x appearing by themselves in P(. . .) denote the event {X = x}. Thus we abbreviate

1



expressions such as P(AB = ab|XY = xy) by P(ab|xy). Sometimes it is necessary to dis-
ambiguate the probability distribution with respect to which E(. . .) is to be computed. In such
cases we use a subscript at the end of the expression consisting of a symbol for the probability
distribution, so E(T )Q is the expectation of T with respect to the distribution Q. In a few in-
stances, we use JφK for logical expressions φ to denote the {0, 1}-valued function evaluating to
1 iff φ is true.

The amount of randomness that can be extracted from an RV R is quantified by the min-
entropy, defined as − log2 maxr P(R = r). The error of the output of an extractor is given as
the total variation (TV) distance from uniform. Given two probability distributions P1 and P2
for R, the TV distance between them is given by

TV(P1,P2) =
1

2

∑
r

|P1(R = r)− P2(R = r)|

=
∑

r:P1(r)>P2(r)

(P1(R = r)− P2(R = r))

=
∑
r

JP1(r) > P2(r)K (P1(R = r)− P2(R = r)) . (S1)

As the name implies, the TV distance is a metric. In particular, it satisfies the triangle inequality:

TV(P1,P3) ≤ TV(P1,P2) + TV(P2,P3). (S2)

See Ref. [35] for this and other basic properties of TV distances.
We sometimes compute TV distances for distributions of specific RVs, conditional or uncon-

ditional ones. For this we introduce the notation PX for the distribution of values ofX according
to P, and PX|Y=y for the distribution of X conditioned on the event {Y = y}. With this nota-
tion, PXPY refers to the product distribution that assigns probability PX(X = x)PY (Y = y) to
the event {X = x, Y = y}.

For the proof of the Protocol Soundness Theorem, we need two results involving the TV
distance. According to the first result, if P and Q are joint distributions of RVs V and W ,
where the marginals of W satisfy P(w) = Q(w), then the distance between them is given by
the average conditional distance. This is explicitly calculated as follows:

TV(PVW ,QVW ) =
∑
w

∑
v

JP(v, w) > Q(v, w)K (P(v, w)−Q(v, w))

=
∑
w

∑
v

JP(v|w)P(w) > Q(v|w)Q(w)K (P(v|w)P(w)−Q(v|w)Q(w))

=
∑
w

∑
v

JP(v|w) > Q(v|w)K (P(v|w)−Q(v|w))P(w)

=
∑
w

TV(PV |W=w,QV |W=w)P(w). (S3)

2



The second result is a special case of the data-processing inequality for TV distance. See
Ref. [36] for this and many other data-processing inequalities. Let V be a random variable
taking values in a finite set V , and let F : V → W be a function so that F (V ) is a random
variable taking values in the setW . Then if P and Q are two distributions of V ,

TV
(
PV ,QV

)
≥ TV

(
PF (V ),QF (V )

)
. (S4)

Here is a proof of this inequality. WriteW = {s1, ..., sc}, and for each i ∈ {1, . . . , c}, define
Vi = {v : f(v) = si}. The Vi form a partition of V . Then we have

TV
(
PF (V ),QF (V )

)
=

1

2

c∑
i=1

|P(V ∈ Vi)−Q(V ∈ Vi)|

=
1

2

c∑
i=1

∣∣∣∣∣∑
v∈Vi

[P(V = v)−Q(V = v)]

∣∣∣∣∣
≤ 1

2

c∑
i=1

∑
v∈Vi

|P(V = v)−Q(V = v)|

= TV
(
PV ,QV

)
. (S5)

We need to refer to the sequences of RVs associated with the first i − 1 trials. To do this
we use notation such as (AB)<i for the outcome sequence A1B1A2B2...Ai−1Bi−1, (XY)<i
for the settings sequence X1Y1...Xi−1Yi−1, and (ABXY)<i for the joint outcomes and settings
sequence A1B1X1Y1...Ai−1Bi−1Xi−1Yi−1. In general we often juxtapose RVs to indicate the
“joint” RV. From our assumption Eqs. 2 and 3 and the fact that pasti subsumes the trial settings
and outcomes from trials 1 through i− 1, we obtain

∀i ∈ (1, ..., n), Pe (XiYi|(ABXY)<i) = Pe(XiYi) = 1/4, (S6)

and

Pe(Ai|XiYi, (ABXY)<i) = Pe(Ai|Xi, (ABXY)<i)
Pe(Bi|XiYi, (ABXY)<i) = Pe(Bi|Yi, (ABXY)<i). (S7)

Eq. S6 can be weakened to accommodate imperfect settings randomness by replacing it with
the following two assumptions, where α ∈ [0, 1/4) is a parameter controlling deviation from
uniformity:

∀i ∈ (1, ..., n), 1/4− α ≤ Pe (XiYi|(ABXY)<i) ≤ 1/4 + α (S8)
Pe(XiYi|(ABXY )<i) = Pe(XiYi|(XY )<i) (S9)

Eq. S6 is a strictly stronger assumption as it implies both Eq. S8 (with α = 0) and Eq. S9.
Eqs. S7, S8, and S9 are the forms of our assumptions used in the proof of the Entropy Production

3



Theorem. Eq. S9 expresses conditional independence of all past outcomes and the upcoming
settings given the past settings. It is a special case of the Markov-chain condition in Ref. [28].

For a generic trial of a two station Bell test, a distribution is defined to be non-signaling if

P(A|XY ) = P(A|X) and P(B|XY ) = P(B|Y ). (S10)

Such distributions form a convex polytope and include the local realist (LR) distributions.
Using the conventions of [22], these are defined as follows: Let λ range over the set of six-
teen four-element vectors of the form (a0, a1, b0, b1) with elements in {+, 0}. Each λ induces
settings-conditional deterministic distributions according to

Pλ(ab|xy) =

{
1, if a = ax and b = by,
0, otherwise.

(S11)

Then a probability distribution P is LR iff its conditional probabilities P(ab|xy) can be written
as a convex combination of the Pλ(ab|xy). That is

P(ab|xy) =
∑
λ

qλPλ(ab|xy), (S12)

with qλ a λ-indexed set of nonnegative numbers summing to 1. This definition agrees with the
one given in the main text.

The eight “Popescu-Rohrlich (PR) boxes” [37] are examples of non-signaling distributions
that are not LR. One of the PR boxes is defined by

PPR(ab|xy) =

{
1/2 if xy 6= 11 and a = b, or if xy = 11 and a 6= b,
0 otherwise,

(S13)

and the other seven are obtained by relabeling settings or outcomes. We take advantage of the
facts that a PR box contains one bit of randomness conditional on the settings and that the PR
boxes together with the 16 deterministic LR distributions of Eq. S11 form the set of extreme
points of the non-signaling polytope [38].

S.2 Proof of the Entropy Production Theorem
The conditions on T given in the main text are that (1) T > 0, (2) E(T )P ≤ 1 for every LR
distribution P, (3) there exists anm > 0 such that E(T )Q ≤ 1+m for every non-signaling distri-
bution Q if the settings distribution is uniform as in Eq. 2, and (4) the bound 1+m is achievable.
Our proof of the Entropy Production Theorem does not require that the fourth condition is sat-
isfied. Furthermore, we prove the Entropy Production Theorem with a weakened form of the
second and third conditions, assuming that T satisfies conditions (2) and (3) with any settings
distribution satisfying Eq. S8. In the following, we call this relaxed version of conditions (1)-(3)

4



“the Bell-function conditions with bound m and settings parameter α”. We also generalize the
Entropy Production Theorem by allowing the Ti to be chosen based on (abxy)<i. We call Ti a
“past-parametrized family of Bell functions” if for all (abxy)<i, Ti(aibixiyi, (abxy)<i) satis-
fies the Bell-function conditions with bound m and settings parameter α when considered as a
function of the results aibixiyi from the i’th trial. By proving the theorem for past-parametrized
Bell functions T , we allow for the possibility of dynamically adapting T during run time, a
feature that could compensate for experimental drift in future implementations of the protocol.
The theorem and its proof can also be directly applied to the special case where Ti is the same
function for all trials i and α = 0.

Theorem 1. Let Ti be a past-parametrized family of Bell functions as defined in the previous
paragraph. Then in an experiment of n trials obeying Eq. S7, Eq. S8 and Eq. S9, the following
inequality holds for all �p ∈ (0, 1) and vthresh satisfying 1 ≤ vthresh ≤ (1 + (3/2)m)n�−1p :

Pe (Pe(AB|XY) > δ, V ≥ vthresh) ≤ �p (S14)

where δ = [1+(1− n√�pvthresh)/2m]n and Pe represents the probability distribution conditioned
on the event {E = e}.

We include the constraint vthresh ≤ (1+(3/2)m)n�−1p for technical reasons. Higher values of
vthresh are unreasonably large and result in pass probabilities that are too low to be relevant. Note
that this bound ensures δ ≥ 2−2n, a fact that will be useful in proving the Protocol Soundness
Theorem in (S.5).

Proof. Since the condition on {E = e} appears uniformly throughout, in this proof we omit
the subscript on Pe specifying conditioning on {E = e}.

The strategy of the proof is to first obtain an upper bound on the one-trial outcome probabil-
ities from the expectations of Bell functions T . This bound can be chained to give a bound on
the probabilities of the outcome sequence as a monotonically decreasing function of the prod-
uct of the conditional expectations of the Ti. That is, a larger product of expectations yields a
smaller maximum probability and therefore more extractable randomness. This product can-
not be directly observed, so we relate it to the observed product V of the Ti via the Markov
inequality applied to an associated positive, mean-1 martingale. In the following, we suppress
the arguments aibixiyi and (ABXY)<i of Ti.

The one-trial outcome probabilities are bounded by means of the following lemma:

Lemma 1. Let T satisfy the Bell-function conditions with bound m > 0 and settings parameter
α. For any non-signaling distribution P satisfying Eq. S8,

max
abxy

P(ab|xy) ≤ 1 + 1− E[T (A,B,X, Y )]P
2m

. (S15)

Proof. The settings-conditional distribution P(ab|xy) is non-signaling, so it can be obtained as
a convex combination of extremal such distributions. The convex combination requires at most

5



one PR box ( [39], Corollary 2.1), so we write P(ab|xy) = pQ(ab|xy) + (1 − p)Q′(ab|xy),
where Q is the PR box and Q′ is LR. We thus have

E(T )P =
∑
abxy

T (abxy)P(abxy) =
∑
xy

(∑
ab

T (abxy)P(ab|xy)

)
P(xy)

= p
∑
abxy

T (abxy)Q(ab|xy)P(xy) + (1− p)
∑
abxy

T (abxy)Q′(ab|xy)P(xy)

≤ p(1 +m) + (1− p) = 1 + pm, (S16)

where the inequality above holds because Q(ab|xy)P(xy) and Q′(ab|xy)P(xy) respectively
define non-signaling and LR distributions satisfying Eq. S8, and hence these distributions re-
spectively satisfy E(T ) ≤ 1 +m and E(T ) ≤ 1. The above inequality can be re-written as p ≥
(E(T )P − 1)/m. Now since the PR box assigns xy-conditional probability 1/2 to at least one
outcome different from ab, it follows that the xy-conditional probability relative to P of an out-
come different from ab is at least p/2. Therefore, P(ab|xy) ≤ 1−p/2 ≤ 1−(E(T )P−1)/(2m).
Since ab and xy are arbitrary, this gives the inequality the lemma.

We can now establish a bound on P(ab|xy) as follows:

P(ab|xy) =
n∏
i=1

P(aibi|(ab)<i,xy)

=
n∏
i=1

P(aibi|(abxy)<i, xiyi)

≤
n∏
i=1

[
1 +

1− E(Ti|(abxy)<i)
2m

]
. (S17)

Here, the first identity is the chain rule for conditional probabilities, and the second follows
from repeated applications of the following identity, which holds for all j in (i+ 1, i+ 2, ..., n)
(where we recall that (xy)<n+1 = xy and (ab)<i(xy)<i+1 = (abxy)<i, xiyi). The third
equality below is a consequence of Eq. S9:

P(aibi|(ab)<i, (xy)<j+1) =
P(aibi, (ab)<i, (xy)<j+1)
P((ab)<i, (xy)<j+1)

=
P(xjyj|aibi, (ab)<i, (xy)<j)P(aibi, (ab)<i, (xy)<j)

P(xjyj|(ab)<i, (xy)<j)P((ab)<i, (xy)<j)

=
P(xjyj|(xy)<j)P(aibi, (ab)<i, (xy)<j)
P(xjyj|(xy)<j)P((ab)<i, (xy)<j)

= P(aibi|(ab)<i, (xy)<j). (S18)

Finally, the inequality in Eq. S17 is a consequence of our assumption in Eq. S7 that the past-
dependent distributions are non-signaling, which allows us to apply the bound from Lemma 1.

6



Now, by twice using the fact that the geometric mean of a set of positive numbers is always less
than or equal to their arithmetic mean, we continue from the last line of Eq. S17:

n∏
i=1

[
1 +

1− E(Ti|(abxy)<i)
2m

]
=

{ n∏
i=1

[
1 +

1− E(Ti|(abxy)<i)
2m

]} 1nn

≤

∑ni=1
[
1 + 1−E(Ti|(abxy)<i)

2m

]
n

n

=

1 + 1
2m
−

∑n
i=1

[
E(Ti|(abxy)<i)

2m

]
n

n

≤

1 + 1
2m
−

[
n∏
i=1

E(Ti|(abxy)<i)
2m

] 1
n

n

=

(
1 +

1− [
∏n

i=1 E(Ti|(abxy)<i)]
1
n

2m

)n
. (S19)

Referring back to the statement of the theorem, we see that δ can be expressed as f(�pvthresh)
where f(x) = [1+(1− n

√
x)/2m]n. Expressing Eq. S19 in terms of this same function f , we see

that the event {P(AB|XY) > δ} implies the event {f (
∏n

i=1 E(Ti|(ABXY)<i)) > δ}. The
latter event is the same as {

∏n
i=1 E(Ti|(ABXY)<i) < f−1(δ) = �pvthresh}, since f−1 is strictly

decreasing. Conjoining the event {V ≥ vthresh} to both sides of the implication, we have
{P(AB|XY) > δ, V ≥ vthresh} implies {

∏n
i=1 E(Ti|(ABXY)<i) < �pvthresh, V ≥ vthresh},

and so by the monotonicity of probabilities,

P (P(AB|XY) > δ, V ≥ vthresh) ≤ P

(
n∏
i=1

E(Ti|(ABXY)<i) < �pvthresh, V ≥ vthresh

)
.

(S20)
The event {Φ} whose probability appears on the left-hand side of this equation is the event
in the theorem statement whose probability we are required to bound. For any values of the
RVs, the two inequalities in the event on the right-hand side imply the inequality in the event
{Ψ} = {V/

∏n
i=1 E(Ti|(ABXY)<i) ≥ 1/�p}. Hence P(Φ) ≤ P(Ψ). It remains to show that

P(Ψ) ≤ �p. For this purpose we define the sequence {Wc}nc=1 of RVs by

Wc =
c∏
i=1

Ti
E(Ti|(ABXY)<i)

, (S21)

so that {Ψ} = {Wn ≥ 1/�p}.

7



By definition, Wc > 0 and the factors Ti/E(Ti|(ABXY)<i) have expectation 1 conditional
on the past. Sequences of RVs with these properties are referred to as test martingales [40] and
satisfy that E(Wn) = 1, which can be verified directly by induction:

E(Wc|(ABXY)<c) = E

(
c∏
i=1

Ti
E(Ti|(ABXY)<i)

∣∣∣∣∣(ABXY)<c
)

= E

((
c−1∏
i=1

Ti
E(Ti|(ABXY)<i)

)
1

E(Tc|(ABXY)<c)
Tc

∣∣∣∣∣(ABXY)<c
)

=

(
c−1∏
i=1

Ti
E(Ti|(ABXY)<i)

)
1

E(Tc|(ABXY)<c)
E (Tc|(ABXY)<c)

= Wc−1, (S22)

where in the second last line, we pulled out factors that are functions of the conditioner (ABXY)<c
by applying the rule that if F is a function of H , then E(FG|H) = FE(G|H). Taking the un-
conditional expectation of both sides of Eq. S22 and invoking the law of total expectation, we
have E(Wc) = E(Wc−1), and so inductively, E(Wn) = E(W1). Since E(W1) = 1, the claim
follows. To finish the proof of the Entropy Production Theorem, we apply Markov’s inequality
to obtain P(Wn ≥ 1/�p) ≤ �p and consequently P(Φ) ≤ �p.

Now that we have proved the Entropy Production Theorem for any past-parametrized family
of Bell functions, we can justify a strategy of setting the remaining Bell functions to Ti = 1
after vthresh is exceeded by the running product mid-protocol. Formally, since the running
product Vi−1 =

∏i−1
i=j Tj is a function of (ABXY)<i, we can define Ti = T conditional on

{Vi−1 < vthresh} and Ti = 1 conditional on the complement. This optional strategy can be used
to eliminate the possibility that statistical fluctuations or experimental drift could cause

∏n
i=1 Ti

to be less than vthresh even though the running product exceeded vthresh at some point prior to n.

S.3 Choosing the Bell Function T
The Entropy Production Theorem does not indicate how to find functions T satisfying the spec-
ified conditions. We seek a high typical value of V =

∏n
i=1 Ti, as this permits larger values of

vthresh and consequently more extractable randomness at the same values of �p and m. Here,
we describe a procedure for constructing a function T that can be expected to perform well if
the trial results are i.i.d. with known distribution. We estimate the distribution from an initial
portion of the run that we set aside as training data, and in a stable experiment we expect that
the trial results’ statistics are i.i.d. to a good approximation. Note however that the optimistic
i.i.d. assumption is only used as a heuristic to construct T ; once T is chosen the guarantees of
the Entropy Production Theorem hold regardless of whether the trial results are actually i.i.d.

8



We first focus on the scenario where Eq. S6 is assumed to hold, then show how to proceed if
this is replaced with the weaker assumptions Eq. S8 and Eq. S9.

The observed measurement outcome frequencies for training data generally yield a weakly
signaling distribution that does not exactly satisfy the non-signaling constraints in Eq. S10, due
to statistical fluctuation. Hence one can obtain an estimated distribution by determining the
maximum likelihood non-signaling distribution for the observed measurement outcomes fre-
quencies as described in Ref. [31]. Let N(xy) be the number of training trials at setting xy and
f(ab|xy) = N(ab|xy)/N(xy) be the empirical frequencies of outcome ab given setting xy. Let
Q(a, b, x, y) be a candidate for the probability distribution from which these frequencies were
sampled. Then up to an additive term independent of Q accounting for the settings probabili-
ties, the log-likelihood of f given Q is L(Q) =

∑
a,b,x,yN(xy)f(ab|xy) ln(Q(a, b|x, y)). We

maximized a variant of this function to find our estimated distribution Q(a, b, x, y):

Maximize
Q

∑
abxy

f(ab|xy) lnQ(a, b, x, y) (S23)

Subject to Q(x, y) = 1/4 for x, y ∈ {0, 1}
Q(a|x, y) = Q(a|x) for x, y ∈ {0, 1}, a ∈ {+, 0}
Q(b|x, y) = Q(b|y) for x, y ∈ {0, 1}, b ∈ {+, 0}.

The first group of constraints encode our knowledge that all settings combinations are equally
likely, and the remaining constraints are the non-signaling constraints. Note that the conditional
expressions in these constraints are equivalently expressed as linear functions of Q(a, b, x, y)
after using the identities Q(x, y) = 1/4.

Once the estimated distribution Q is obtained, we maximize the typical values of V by
taking advantage of the observation that the conditions on T imply that V −1 is a conservative p-
value against local realism [31]. Such p-values were studied in Ref. [31], which gives a general
strategy, the PBR method, for maximizing E(ln(V ))Q. This is useful because typical values of
V are close to exp(nE(ln(T ))Q): Since ln(V ) =

∑n
i=1 ln(Ti) is a sum of i.i.d. bounded terms

(given our optimistic assumption), the central limit theorem ensures that lnV is approximately
normally distributed with mean nE(ln(T ))Q. We therefore perform the following optimization
problem to find T :

Maximize
T

E(ln(T ))Q (S24)

Subject to E(T )Pλ ≤ 1 ∀λ
T (0, 0, x, y) = 1 ∀x, y,

where Pλ refers to the 16 conditionally deterministic LR distributions in Eq. S11 with uniform
settings distributions. This ensures that E(T )PLR ≤ 1 for all LR distributions PLR with uniform
settings distributions. The second constraint is motivated by the fact that in our experiments, an

9



overwhelming fraction of the trials have no detections for both stations. While it is possible that
a better E(ln(T ))Q can be obtained without this constraint, we have found that the improvement
is small and likely not statistically significant given the amount of training data used to deter-
mine the results distribution. Since the objective functions are concave and the constraints are
linear, the optimization problems given in Eq. S23 and Eq. S24 are readily solved numerically
with standard tools.

Given the assumption that the trial results are i.i.d., the previous paragraph shows that the
typical values for V are exponential in the number of trials, V = e−nE(ln(T ))−o(n). If the exper-
iment is successful in showing violation of local realism, E(ln(T )) is positive. Neglecting the
contribution from o(n), with vthresh = enE(ln(T )), we can bound − ln(δ) as

− ln(δ) = −n ln(1 + (1− (�penE(ln(T )))1/n)/(2m))
= −n ln(1 + (1− eE(ln(T ))+ln(�p)/n)/(2m))
≥ −n(1− eE(ln(T ))+ln(�p)/n)/(2m)
= n(eE(ln(T ))+ln(�p)/n − 1)/(2m)
≥ (nE(ln(T )) + ln(�p))/(2m). (S25)

where we used − ln(1 + x) ≥ −x and ex − 1 ≥ x. This shows that asymptotically (with �p
constant) we get at least E(ln(T )) log2(e)/(2m) = E(log2(T ))/(2m) bits of randomness per
trial. For the empirical distribution obtained from the fifth data set (“Data Set 5”) used for the
protocol according to Eq. S23, we obtain E(log2(T ))/2m = 1.42×10−4. The bound in Eq. S25
shows that we can get an asymptotically positive number of bits of randomness per trial even
with �p exponentially small in n.

Now we turn to the problem of finding a function satisfying the condition E(T )PLR ≤ 1
for all LR distributions PLR with settings distribution constrained only by the weaker condition
Eq. S8, which replaces the stronger exact uniformity condition of Eq. S6. To do this, we show
that it is sufficient to check only distributions with the extremal settings distributions where two
settings have probability 1/4+α and the two other settings distributions have probability 1/4−
α. To see why this is possible, for a fixed positive Bell function T , let P be an LR distribution
whose settings distribution is constrained by Eq. S8. Taking advantage of the representation in
Eq. S12,

E(T )P =
∑
abxy

T (abxy)P(ab|xy)P(xy) =
∑
abxy

T (abxy)

(∑
λ

qλPλ(ab|xy)

)
P(xy)

=
∑
λ

qλ
∑
abxy

T (abxy)Pλ(ab|xy)P(xy) ≤ max
λ

∑
abxy

T (abxy)Pλ(ab|xy)P(xy), (S26)

so the expected value of T with respect to P is always less than or equal to the expected value
of T with respect to a conditionally deterministic LR distribution Pλ with the same settings
distribution. Since each deterministic LR distribution assigns conditional probability 1 to a sin-
gle outcome ab for each of the four setting choices xy, the sum

∑
abxy T (abxy)Pλ(ab|xy)P(xy)

10



contains only four nonzero terms. Consider the two largest values of T (abxy) and the two small-
est values of T (abxy) appearing in the four nonzero terms. Note that

∑
abxy T (abxy)Pλ(ab|xy)P(xy) ≤∑

abxy T (abxy)Pλ(ab|xy)P∗(xy), where P∗(XY ) is the distribution that assigns probability
1/4 + α to the two settings corresponding to the two largest T , and probability 1/4 − α to
the two settings corresponding to the two smallest T . Hence for any T , we can ensure that
E(T )P ≤ 1 holds for all LR distributions by checking that E(T )P ≤ 1 holds for each condi-
tional distribution PλAB|XY coupled with each of the i = 1, . . . ,

(
4
2

)
= 6 settings distributions

SiXY assigning probability 1/4 +α to two settings and 1/4−α to two other settings. This leads
us to the maximization problem

Maximize
T

E(ln(T ))Q (S27)

Subject to E(T )Pλ
AB|XY S

i
XY
≤ 1 ∀λ, i

T (0, 0, x, y) = 1 ∀x, y.

The new problem maximizes the same objective function as in Eq. S24 subject to a larger, but
still finite, number of constraints. It can be solved numerically to find a Bell function for the
weak settings distribution.

S.4 The TMPS Algorithm
A strong randomness extractor with parameters (σ, �, q, d, t) is a function Ext : {0, 1}q ×
{0, 1}d → {0, 1}t with the property that for any random string R of length q and min-entropy at
least σ, and an independent, uniformly distributed seed string S of length d, the distribution of
the concatenation Ext(RS) with S of length t+ d is within TV distance � of uniform. There are
constructions of extractors that extract most of the input min-entropy σ with few seed bits. For
a review of the achievable asymptotic tradeoffs, see Ref. [41], chapter 6. For explicit extractors
that perform well if not optimally, we used a version of Trevisan’s construction [25] imple-
mented by Mauerer, Portmann and Scholz [26], which we adapted1 to make it functional in our
environment and to incorporate recent constructions achieving improved parameters [42]. We
call this construction the TMPS algorithm. For a fixed choice of σ, � and q, the TMPS algorithm
can construct a strong randomness extractor for any value t obeying the following bound:

t+ 4 log2 t ≤ σ − 6 + 4 log2(�). (S28)

Given t, the length of the seed satisfies

d ≤ w2 ·max {2, 1 + d[log2(t− e)− log2(w − e)]/[log2 e− log2(e− 1)]e} , (S29)

wherew is the smallest prime larger than 2×dlog2(4qt2/�2)e. We note that the TMPS extractors
are secure against classical and quantum side information [26], and this security is reflected in
the parameter constraints. Since we do not take direct advantage of this security, it is in principle

1Our adapted source code is available at https://github.com/usnistgov/libtrevisan.

11

https://github.com/usnistgov/libtrevisan


possible to improve the parameters in the Protocol Soundness Theorem. It may also be possible
relax the requirement of seed uniformity with more advanced constructions. For the purpose
randomness amplification this is theoretically accomplished in Ref. [43].

For the bound on the the number of seed bits given after the Protocol Soundness Theorem
in the main text, we have q = 2n and � = �ext/2. Since for any r, there is a prime w satisfying
r < w ≤ 2r, w = O(log(n) + log(t/�)) = O(log(nt/�)), where we pulled out exponents from
the log, and dropped and arbitrarily increased the implicit constants in front of each term to
match summands. The coefficient of w2 in the bound on d is O(log(t)), because of the “minus”
sign in front of the term containing w. Multiplying gives d = O(log(t) log(nt/�ext)2).

S.5 Proof of the Protocol Soundness Theorem
The distinction between the stations was needed to establish the inequality in the Entropy Pro-
duction Theorem and plays no further role in this section. We therefore simplify the notation by
abbreviating C = AB and either Z = XY or Z = XYE. In the former case P(. . .) refers to
probabilities conditional on {E = e}. Otherwise, P(. . .) involves no implicit conditions. The
Protocol Soundness Theorem holds regardless of which definition of Z is in force. We write
Rpass to refer to the RV that takes value 1 conditional on the passing event {V ≥ vthresh} and 0
otherwise. The constants �p and δ appearing below are the same as in the Entropy Production
Theorem.

Theorem 2. Let 0 < �ext, κ < 1. Suppose P(pass) ≥ κ, and suppose t is a positive integer
satisfying

t+ 4 log2 t ≤ − log2 δ + log2 κ+ 5 log2 �ext − 11. (S30)

Then if Ext : {0, 1}2n × {0, 1}d → {0, 1}t is obtained by the TMPS algorithm with parameters
σ = − log2[2δ/(κ�ext)] and � = �ext/2, and S is a random bit string of length d independent of
the joint distribution of C,Z, Rpass, then the joint distribution of U = Ext(CS), Z, S and Rpass
satisfies

TV
(
PUZS|Rpass=1,PunifU PunifS PZ|Rpass=1

)
≤ �p/P(pass) + �ext, (S31)

where Punif denotes the uniform probability distribution.

At this point it is tempting to just apply an extractor to AB with parameter σ given by the
nominal �p-smooth min-entropy σ = − log2(δ). However, this does not guarantee the strong
condition Eq. S31. Specifically, there are three reasons that Eq. S14 of the Entropy Production
Theorem does not immediately support the application of an extractor to AB. The first is that
as specified, the extractor input should have min-entropy − log2 maxab P(AB = ab) = σ with
no smoothness error. The second is that the settings-conditional smooth min-entropies can be
substantially smaller than the nominal one. The third is that the min-entropy is also affected by
the probability of passing being less than 1. Accounting for these effects requires an analysis
of the settings- and pass-conditional distributions and the extractor parameters specified in the
theorem.

12



Proof. The proof proceeds in two main steps inspired by the corresponding arguments in Ref. [2].
In the first we determine a probability distribution P∗ that is within �p of P but satisfies an ap-
propriate bound on the conditional probabilities of C with probability 1 rather than 1− �p. The
distribution P∗’s marginals agree with those of P on ZS. The probabilities conditional on abort-
ing also agree, and uniformity and independence of S is preserved. In the second step, we apply
a proposition from Ref. [44] on applying extractors to distributions such as P∗ whose average
maximum conditional probabilities satisfy a specified bound. The proposition enables us to
determine the extractor parameters that achieve the required final distance �p/P(pass) + �ext in
the theorem.

The Entropy Production Theorem guarantees that P(P(C|Z) > δ,Rpass = 1) ≤ �p. In the
case where E is included in Z, this follows by the uniformity in {E = e} of the theorem’s
conclusion:

P(P(C|Z, E) > δ,Rpass = 1) =
∑
e

P(P(C|Z, E) > δ,Rpass = 1|E = e)P(E = e)

=
∑
e

P(P(C|Z, E = e) > δ,Rpass = 1|E = e)P(E = e)

≤
∑
e

�pP(e)

= �p. (S32)

Using the following construction, one may observe that for any random variable U with
values in a set of cardinality K and γ satisfying 1/K ≤ γ, and any distribution P′ of U ,
there exists P′′ such that P′′(U = u) ≤ γ for all possible outcomes u and P′′ is within TV
distance P′(P′(U) > γ) of P′. To construct P′′, for u such that P′(u) > γ, set P′′(u) = γ. To
compensate for the reduced probabilities, increase the values of P′ to obtain those of P′′ without
exceeding γ on the set {u : P′(u) ≤ γ} so that P′′ is a normalized probability distribution.
This is possible because in constructing P′′ from P′, the total reduction in probability on {u :
P′(u) > γ} given by r− =

∑
u:P′(u)>γ(P′(u) − γ) is less than the maximum total increase

possible given by r+ =
∑

u:P′(u)≤γ(γ − P′(u)), as a consequence of γ ≥ 1/K. To see this,
compute r+ − r− =

∑
u(γ − P′(u)) ≥

∑
u(1/K − P′(u)) = 0. The distance TV(P′,P′′) is

given by
∑

u:P′(u)>γ(P′(u) − γ) ≤ P′(P′(U) > γ). We can now construct P∗ by defining its
conditional distributions on C. For this, substitute U ← C, P′(U) ← P(C|z, Rpass = 1), γ ←
δ/P(Rpass = 1|z) and P′′(U) ← P∗(C|z, Rpass = 1). The constraint on γ is satisfied because
the upper bound on vthresh in the statement of the Entropy Production Theorem ensures that
δ ≥ 2−2n. Each conditional distribution satisfies P∗(C|z, Rpass = 1) ≤ δ/P(Rpass = 1|z), which
is equivalent to P∗(C, Rpass = 1|z) ≤ δ, and is within TV distance P

(
P(C|z, Rpass = 1) >

δ/P(Rpass=1|z)
∣∣z, Rpass = 1) of PC|z,Rpass=1. The joint probability distribution P∗ is determined

pointwise from the already assigned values of P∗(c|zrpass) for rpass = 1 as

P∗(czsrpass) =
{

P∗(c|zrpass)P(zsrpass) if rpass = 1
P(czsrpass) otherwise.

(S33)

13



Since the marginal distribution of ZSRpass is unchanged, the full TV distance between P and P∗
is given by the average conditional TV distance with respect to ZSRpass, see Eq. S3. Since the
conditional TV distance is zero when Rpass = 0 and from independence of S, we obtain

TV(P∗CZSRpass ,PCZSRpass)

=
∑
zsrpass

TV
(
P∗C|zsrpass ,PC|zsrpass

)
P(zsrpass)

=
∑
zsrpass

TV
(
P∗C|zsrpass ,PC|zsrpass

)
Jrpass = 1KP(zsrpass)

≤
∑
zsrpass

P
(
P(C, Rpass = 1|z) > δ

∣∣z, Rpass = 1)Jrpass = 1KP(zsrpass)
=

∑
zrpass

P
(
P(C, Rpass = 1|z) > δ

∣∣z, Rpass = 1)Jrpass = 1KP(zrpass)
=

∑
czrpass

JP(crpass|z) > δKP(c|zrpass)Jrpass = 1KP(zrpass)

=
∑
czrpass

JP(crpass|z) > δKJrpass = 1KP(czrpass)

= P(P(CRpass|Z) > δ,Rpass = 1)
≤ P(P(C|Z) > δ,Rpass = 1)
≤ �p. (S34)

At this point we can also bound the TV distance conditional on passing. Since P∗(Rpass) =
P(Rpass), we can apply Eq. S3 and the above bound on the distance to get

�p ≥ TV
(
P∗CZSRpass ,PCZSRpass

)
=

∑
r

TV
(
P∗CZS|Rpass=r,PCZS|Rpass=r

)
P(Rpass = r)

= TV
(
P∗CZS|Rpass=1,PCZS|Rpass=1

)
P(Rpass = 1). (S35)

We conclude that

TV
(
P∗CZS|Rpass=1,PCZS|Rpass=1

)
≤ �p/P(Rpass = 1). (S36)

For the second main step, we need the average “guessing probability” of C given Z condi-
tional on {Rpass = 1}. This is given by∑

z

max
c

(P∗(c|z, Rpass = 1))P(z|Rpass = 1) ≤
∑
z

δ

P(Rpass = 1|z)
P(z|Rpass = 1)

= δ
∑
z

P(z)
P(Rpass = 1)

≤ δ/κ. (S37)

14



We remark that here it is necessary to assume the lower bound κ on P(Rpass = 1) in order to
proceed; otherwise the bound in Eq. S37 would become unbounded due to potentially arbitrarily
small values of P(Rpass = 1). Now we can apply Proposition 1 of Ref. [44]. The next lemma
extracts the conclusion of this proposition in the form we need. It is obtained by substituting the
variables and expressions in the reference as follows: X ← C, Y ← S, E ← Z, E(X, Y ) ←
Ext(CS), k ← − log2(δ/κ)−log2(2/�ext), �← �ext/2 and the distributions are replaced with the
corresponding ones that are conditional on {Rpass = 1}. The guessing entropy in the reference
is the negative logarithm of the the average guessing probability in Eq. S37.

Lemma 2. Suppose that Ext is a strong extractor with parameters
(− log2(2δ/(κ�ext)), �ext/2, 2n, d, t). Write U = Ext(CS). Then we have the following
bound:

TV
(
P∗UZS|Rpass=1,P

unif
U PSP∗Z|Rpass=1

)
≤ �ext. (S38)

To apply the lemma, we obtain Ext by the TMPS algorithm with the parameters in the
lemma. Expanding the logarithms as σ = − log2(δ) + log2(κ) + log2(�ext) − 1 and log2(�) =
log2(�ext)− 1 and substituting in Eq. S28 gives the requirement

t+ 4 log2 t ≤ − log2(δ) + log2(κ) + 5 log2(�ext)− 11, (S39)

as asserted in the Protocol Soundness Theorem. The number of seed bits d is obtained from
Eq. S29.

It remains to determine the overall TV distance conditional on passing. Applying Eq. S4
with V = C,Z,S and F defined as F (C,Z,S) =

(
Ext(C,S),Z,S

)
, and applying Eq. S36, we

have

TV
(
P∗UZS|Rpass=1,PUZS|Rpass=1

)
≤ TV

(
P∗CZS|Rpass=1,PCZS|Rpass=1

)
≤ �p/P(Rpass = 1). (S40)

Then by Eq. S2, Eq. S38 and Eq. S40, we have

TV
(
PUZS|Rpass=1,PunifU PunifS P∗Z|Rpass=1

)
≤ �ext + �p/P(Rpass = 1). (S41)

As P∗Z|Rpass=1 = PZ|Rpass=1, the statement of the theorem follows.

As discussed in the main text, the Protocol Soundness Theorem implies that the uncondi-
tional TV distance from an “ideal protocol” can be bounded by max(�p + �ext, κ). This error
parameter is closely related to the security definitions appearing in, for instance, Equation (1)
of [45] and Definition 4 of [29]. To explain how we arrive at max(�p + �ext, κ), note that an
ideal protocol may abort with positive probability, but conditioned on not aborting it produces
perfectly uniform output independent of side information. That is, the distribution of an ideal
protocol PidealUZSRpass must satisfy P

ideal
UZS|Rpass=1 = P

unif
U PunifS PidealZ|Rpass=1, but the distribution of the

ideal protocol is otherwise unconstrained when Rpass = 0. Given our actual protocol distribu-
tion P we can define a particular ideal distribution with the same probability of passing as the
actual protocol by setting PidealUZS|Rpass=1 = P

unif
U PunifS PZ|Rpass=1, PidealUZS|Rpass=0 = PUZS|Rpass=0, and

15



Pideal(Rpass = 1) = P(Rpass = 1). If P(Rpass = 1) ≥ κ, the unconditional TV distance from P
to this ideal protocol can be bounded by

TV (PUZSRpass ,PidealUZSRpass) =
∑
r=0,1

TV (PUZS|Rpass=r,PidealUZS|Rpass=r)P(Rpass = r)

= TV (PUZS|Rpass=1,PidealUZS|Rpass=1)P(Rpass = 1)
≤ [�p/P(Rpass = 1) + �ext]P(Rpass = 1)
≤ �p + �ext, (S42)

where above we used, in order, Eq. S3, PidealUZS|Rpass=0 = PUZS|Rpass=0, Eq. S31, and P(Rpass =
1) ≤ 1. Alternatively, if P(Rpass = 1) < κ, we have

TV (PUZSRpass ,PidealUZSRpass) = TV (PUZS|Rpass=1,P
ideal
UZS|Rpass=1)P(Rpass = 1)

≤ 1 · κ
= κ, (S43)

as the TV distance can never be greater than one. Thus we see that the distance from the ideal
protocol is bounded by max(�p + �ext, κ). However, as noted in the main text, we considered
a more conservative overall error parameter �fin = max(�p/κ + �ext, κ). This ensures that
for all pass probabilities exceeding κ, the pass-conditional distribution of the output is within
�p/P(pass) + �ext ≤ �p/κ+ �ext ≤ �fin of PunifU PunifS PZ|Rpass=1.

S.6 Protocol Application Details
The Protocol Soundness Theorem supports the protocol given in Table S1, with overall sound-
ness error given by �fin = max(�p/κ+ �ext, κ). A protocol is furthermore complete if there exist
real-world systems that pass the protocol with reasonably high probability. The completeness
of our protocol is supported by quantum mechanics, which predicts experimental distributions
that violate nontrivial Bell inequalities [17] and pass the protocol with high probability. Com-
pleteness is also witnessed by our repeated successful implementations of the protocol.

The five new data sets reported in the main paper were taken in 2017. Each trial in a data
set encompassed fourteen time intervals, and in a given trial, the outcome “+” was recorded if
there was a detection in any one of these intervals and “0” otherwise. The number of intervals
was fixed and chosen in advance of running the protocol. The five data sets were analyzed in the
order in which they were taken. We determined the Bell function T from training data consisting
of the first 5 × 106 trials as explained in S.3. We chose 5 × 106 trials so that we could obtain
a Bell function T using an accurate estimate of the experimental distribution of measurement
outcomes without sacrificing too much data that could be used for randomness generation. After
the protocol was officially run on a data set, the same data set was re-analyzed using different
lengths of training portions to see if a different length should be used for subsequent data sets,
but there was never clear evidence to suggest that we should have used a different length for the
training portion.

16



Table S1: Protocol for Randomness Generation
1. Choose a Bell function T satisfying the conditions of the Entropy Production Theorem,
a number of trials n to be run, a threshold for passing vthresh > 1, error parameters
�p, �ext, κ > 0, and a positive integer t for which Eq. 5 is satisfied.

2. (Entropy Production) Run a succession of n experimental trials, where in each trial
i Alice and Bob randomly and uniformly choose respective settings Xi, Yi ∈ {0, 1}, and
record respective outputs Ai, Bi ∈ {+, 0}. (Optional) Calculate

∏i
j=1 T (Aj, Bj, Xj, Yj)

after each trial and re-set T to the constant function 1 for the remainder of the experiment
if
∏i

j=1 T (Aj, Bj, Xj, Yj) > vthresh.

3. Compute
∏n

i=1 T (Ai, Bi, Xi, Yi) and abort if this quantity does not exceed vthresh.

4. (Extraction) Generate a random and uniform d-bit seed string S where d is given by
Eq. S29 with q = 2n, � = �ext/2. Output U = Ext(AB,S) with the security guarantee
given by Eq. 6.

After training, we inferred an expected value nµ and variance nσ2 of
∑n

i=1 ln(Ti) on the
remaining trials assuming i.i.d. trials and Gaussian statistics according to the central limit theo-
rem, where n and µwere calculated according to the distribution obtained from the optimization
problem of Eq. S23. Note that under these assumptions, we treat

∑n
i=1 ln(Ti) as if it were a sum

of independent and bounded RVs. Since V = exp (
∑n

i=1 ln(Ti)) we can then choose vthresh so
that it has a 0.95 chance of being exceeded according to the Gaussian approximation, by setting
vthresh = e

nµ−1.645
√
nσ. For Data Sets 3, 4 and 5, vthresh was chosen to be smaller than this

value to increase the chance of passing the protocol while still meeting desirable benchmarks
for extractable randomness.

We now discuss our application of the protocol to Data Set 5, and then summarize the main
results for all five data sets in Table S4. Data Set 5 set consists of 60,110,210 trials, roughly
twice as long as each of the first four data sets. The counts for each trial outcome from the
first 5 × 106 trials are shown in Table S2. The maximum likelihood non-signaling distribution
corresponding to these counts is shown in Table S3. We determined T from this distribution,
the values of T are shown in Table 1 of the main text.

Table S2: Result counts for the first 5× 106 trials of Data Set 5.
ab = ++ ab = +0 ab = 0+ ab = 00

xy = 00 3166 1851 2043 1243520
xy = 01 3637 1338 13544 1230633
xy = 10 3992 13752 1226 1230686
xy = 11 357 17648 16841 1215766

The 0.95 rule for determining vthresh given that there are 55,110,210 trials for the protocol
yields vthresh = 8.79 × 1036. We chose a more conservative value of vthresh = 1.5 × 1032 to

17



Table S3: Maximum likelihood non-signaling distribution according to the counts in Table S2,
rounded to eight decimal places.

ab = ++ ab = +0 ab = 0+ ab = 00
xy = 00 0.00063301 0.00036794 0.00041085 0.24858820
xy = 01 0.00073159 0.00026936 0.00270824 0.24629081
xy = 10 0.00080002 0.00277179 0.00024384 0.24618435
xy = 11 0.00007087 0.00350093 0.00336896 0.24305924

improve the odds of passing the protocol, while still allowing for the extraction of 1024 bits
uniform to within 10−12. This threshold corresponds to a probability of passing of roughly
0.9916 according to the i.i.d. scenario described above. Running the protocol, this threshold
was exceeded, with a final value of V = 2.018× 1041.

The running product
∏c

i=1 Ti first exceeded vthresh at trial number c = 41, 243, 976, and
one has the option of setting the remaining Ti = 1 regardless of outcome for the rest of the
data run. The soundness of this procedure is justified by the adaptive properties of the Entropy
Production Theorem. In our application of the protocol, we implemented a similar strategy
without technically changing the Bell function, by relabeling all outcomes to 0 starting at trial
number c + 1. This also results in Ti = 1 for the remainder of the experiment. This strategy is
justified as our assumptions allow for Alice and Bob to cooperatively make arbitrary changes to
the experiment in advance of a trial based on the past, which includes the current running prod-
uct. Turning off the detectors to guarantee outcomes of 0 is one such change, and in principle
there was sufficient time (at least 5µs) for the necessary communication to take place after the
previous trial.

Throughout, we did not consider the length d of the seed in making our choices and deter-
mined d from the other parameters according to Eq. S29. For applying the extractor to Data
Set 5, we used 315,844 seed bits. The seed bits were collected from one of the random number
generators used to select the settings in [13]. Specifically, each seed bit came from the XOR
of two bits generated by the photon-sampling random number generator described in [13]. It
took 317 seconds for our computer to construct the extractor according to the TMPS algorithm
and generate the explicit final output string. Here is the final output string that results from
applying the extractor to the string AB, when AB is obtained with relabeling of all outcomes
to 0 starting at trial number 41, 243, 977 (after vthresh is exceeded by the running product).

11100010011111111101001100001111100101010101001101111001111010110101101000011011000111010001101000111010011110011100101101100100
10111111111001100010110010110111101100101111010011001101101111010100111001011010111111011110010100110001000101011000001111111101
11011001110001111100010010011100011100000000010110010101101111001011001001000001101110110000000111110111001110001100101110001100
10110110001100011101001001001010101000100001010101001001011101010101001010100111001101001010001010100001101111110110011011110000
11100110100110010111001011000110010100101000110101100100000110111000101101001101110110111111001110110011100000001111001111101100
10110000111110011100110111110110101111000001010001010110100010011101011000001001011100010110101101111100110100001110101110110101
10001010011111011110111001000001000110111111110011101001110100111000000100101100010011101110100001110101111001001011111111001100
01111011101001101010101100010010000011111110010101011010111111100011110110001010111011000001111000011111101100100010001001000010

After the protocol was run, we ran consistency checks on the data sets to look for potential
inconsistencies with Eq. 3, the no-signaling assumption. Using the tests described in Ref. [13],
we examined the four signaling equalities: 1: P(A|X = 0, Y ) = P(A|X = 0), 2: P(A|X =

18



Table S4: Summary of application of protocol to data sets. For fixed goal choices of �fin, the
error parameters were computed according to the formula �p = κ2 = (0.95 �fin)2, �ext = 0.05 �fin.
Error parameters were chosen in advance of running the protocol for Data Sets 3, 4 and 5; the
�fin and t values for Data Sets 1 and 2 are marked with an asterisk as they were not chosen in
advance and are only included for illustrative purposes. We remark that the quantity 1/vthresh
can also be interpreted as a p-value against local realism [31].

Data Set n m 95% cut off vthresh �fin t V > vthresh
1 24865320 0.01066 4.68× 1016 4.68× 1016 10−6∗ 512∗ Yes
2 24809970 0.01126 1.30× 105 1.30× 105 0.01∗ 61∗ Yes
3 24818959 0.01163 9.74× 1019 1017 10−6 512 Yes
4 24846822 0.01063 6.57× 1015 1015 10−6 256 Yes
5 55110210 0.01004 8.79× 1036 1.5× 1032 10−12 1024 Yes

Table S5: 2-tail p-values for consistency checks
Data Set Sig. 1 Sig. 2 Sig. 3 Sig. 4

Data Set 1 0.507 0.777 0.290 0.323
Data Set 2 0.765 0.965 0.115 0.684
Data Set 3 0.633 0.072 0.381 0.099
Data Set 4 0.144 0.320 0.844 0.356
Data Set 5 0.879 0.131 0.554 0.885

1, Y ) = P(A|X = 1), 3: P(B|X, Y = 0) = P(B|Y = 0), and 4: P(B|X, Y = 1) =
P(B|Y = 1). For these tests we used statistics whose asymptotic distributions would approach
the standard normal with mean 0 and variance 1, if the trials were i.i.d. We report the p-values
obtained from these tests for all data sets in Table S5, which do not suggest any inconsistencies.

Prior to the analysis of the five data sets reported in the main text, the protocol was applied
to data sets taken as part of the experiment reported in Ref. [13]. These results are described
in [46]. After setting aside the first 5 × 107 trials of the data set XOR 3 as a training set to
construct the function T and choose a threshhold vthresh based on the 95% rule, the protocol was
applied to the rest of the data set with parameters �p = 3.1797× 10−4 and �ext = 3.533× 10−5,
which were chosen to minimize �p/κ + �ext for κ = 1/3 while satisfying Eq. 5. This choice
of parameters was suboptimal for minimizing either �fin or max(�p + �ext, κ), the two figures
of merit disucssed in the main text. However, the instance of the TMPS algorithm induced
by the above choice of parameters would have been induced by other choices of parameters
that perform better according to these figures of merit. The same extraction is induced by
�p = 3.6509 × 10−4, �ext = 3.5330 × 10−5, and κ = 4.0042 × 10−4, which leads to a distance
of max(�p + �ext, κ) = 4.0042× 10−4 from an ideal protocol for the extraction of 256 bits. We
can also choose �p = 3.370 × 10−4, �ext = 3.533 × 10−5, and κ = 0.0184 to induce the same
extraction with an �fin parameter of 0.0184.

Statistically significant settings nonuniformity was detected for some of the sets examined

19



in [46]. This was consistent with the finding in [13] that a combination of uncontrolled envi-
ronmental variables and the synchronization electronics introduced small biases in the settings.
This effect is not present in the 2017 data sets, which used a reliable pseudorandom source
for settings randomness. As the Entropy Production Theorem can tolerate small biases in the
settings distribution, we can explore how the protocol would have performed on XOR 3 had we
selected, prior to running the protocol, a nonzero settings-bias parameter α. We note that the
protocol parameters must be chosen prior to executing a secure protocol, and since we did not
choose a nonzero α in advance of examining XOR 3, we report the following calculations only
as a retrospective diagnostic. In principle it is impossible to measure α through statistical tests
of the output of the random number generators that choose the settings, because the settings
probability can appear random, unbiased, and independent even while changing from trial to
trial within the bounds of a potentially large α. To choose an example α to study, we exam-
ined 95 % confidence intervals for the individual settings probabilities from the six data sets
in [13]. The largest absolute difference from 0.5 among the endpoints of these six intervals was
0.000211 for Alice and 0.000150 for Bob. Assuming independence between Alice and Bob (an
assumption which was not contradicted by our statistical tests), we computed the most and least
likely measurement configurations given this largest difference from 0.5 for Alice’s and Bob’s
settings probability, and found that these would be contained in the interval (0.25−α, 0.25+α)
for α = 0.000181. For this example choice of α, performing the modified optimization problem
described in S.3 yields a T function with m = 0.01179, and for this T function, the expected
threshold computed according to the 95 % rule is vthresh = 5.25× 105, if we assume the “worst-
case” settings distribution among the six extremal settings distributions that assign probabil-
ity 0.25 + α to two settings configurations and 0.25 − α to two other settings configurations.
This threshold is passed when the protocol is re-run now with this non-zero α. For �p values
of (0.01, 0.001, 0.0001, 0.00001) we get corresponding − log2 δ values of (524, 383, 242, 101),
which is a moderate reduction compared to the corresponding values of (582, 444, 306, 168)
obtained by the running the protocol with α = 0. Alternatively, we can fix �p and study how
− log2 δ changes with α. For one particular choice of �p = 3.1797 × 10−4, which was the
smallest �p value considered earlier in analyses of XOR 3, α values of (0, 0.00001, 0.0001,
0.001) yield − log2 δ values of (367, 366, 321, 94). The largest value α = 0.001 in this list may
be considered a conservative choice: if in the first calculation above we had used 99.999998 %
instead of 95 % confidence intervals, we would have obtained a value of α ≈ 0.001/3 instead
of α = 0.000181.

S.7 Performance of Previous Protocols.
Other protocols in the literature could not be used for our data sets for various reasons. Many
protocols apply to different measurement scenarios. For instance, [4] describes a protocol in-
volving three separated measurement stations, and while [27] provides impressive expansion
rates and is secure against quantum side information, it requires eight separate devices. Other
protocols exploring quantum side information in Refs. [3, 8, 30] either also apply to different

20



experimental setups or provide only asymptotic security results as the number of trials n ap-
proaches infinity. The first protocol achieving security against quantum side information [6]
applies to a bipartite experiment like ours but requires systems that achieve per-trial Bell vio-
lations much higher than ours. Another study [11] of bipartite experiments with data regimes
characteristic of photonic systems applies to i.i.d. scenarios.

The protocols of Refs. [5, 29] are applicable to our experimental scenario while making
minimal assumptions, and given enough trials could work for any violation regime. Ref. [5]
obtained protocols for assumptions equivalent to ours, but considered also the case where the
distributions are in addition assumed to be quantum achievable. Ref. [29], which uses the
Entropy Accumulation Theorem of Ref. [28], obtained protocols assuming that the distributions
are quantum achievable, but allowing for quantum side information. However, these protocols
are ineffective for the numbers of trials in our data sets, which we illustrate with a heuristic
argument. Both protocols are based on the Clauser-Horne-Shimony-Holt (CHSH) Bell function
[47]

T c(a, b, x, y) =


1 if (x, y) 6= (1, 1) and a = b
1 if (x, y) = (1, 1) and a 6= b
0 otherwise.

(S44)

The statistic T c = n−1
∑n

i=1 T
c
i used by these protocols for witnessing accumulated violation

satisfies E(T c) ≤ 0.75 under LR, while E(T c) = 0.75009787 for the distribution in Table
S3. The completely predictable LR theory that only produces “00” outcomes regardless of the
settings satisfies E(T c) = 0.75, but in an experiment of n = 55, 110, 210 trials, this theory can
produce a value of T c exceeding 0.75009787 with probability roughly 0.047. Thus, based on
this statistic alone, we cannot infer the presence of any low-error randomness.

The protocol of Ref. [5] (the PM protocol for short, see [2, 7] for amendments), can be
modified to work with any Bell function, and there are methods for obtaining better Bell func-
tions [9, 10] or simultaneously using a suite of Bell functions [48]. Here, we demonstrate that
for any choice of Bell function, the method of [5] as refined in [2] cannot be expected to effec-
tively certify any randomness from an experiment distributed according to Table S3 unless the
number of trials exceeds 1.56× 108, which is larger than the number of trials in our data runs.

For the most informative comparison to our protocol, we consider the PM protocol without
their additional constraint that the distribution be induced by a quantum state. To derive a bound
on the performance of the PM protocol, we refer to Theorem 1 of [2]. This theorem involves
a choice of Bell function denoted by I (analogous to our T ), a threshold Jm (analogous to our
vthresh) to be exceeded by the Bell estimator Ī = n−1

∑n
i=1 Ii, and a function f that we discuss

below. To be able to extract some randomness, the theorem requires that

nf(Jm − µ) > 0. (S45)

The parameter µ is given by (Imax + INS)
√

(2/n) ln(1/�) where Imax is the largest value in the
range of the Bell function I , INS ≤ Imax is the largest possible expected value of I for non-
signaling distributions, and 0 < � ≤ 1 is a free parameter that is added to the TV distance

21



from uniform for the final output string. Smaller choices of �, which is analogous to our �p, are
desirable but require larger n for the constraint Eq. S45 to be positive as we will see below. We
also note that Eq. S45 is a necessary but not sufficient condition for extracting randomness; in
particular, we ignore the negative contribution from the parameter �′ of [2] (somewhat analogous
to the parameter κ in the statement of the Protocol Soundness Theorem in S.5) as well as any
error introduced in the extraction step.

For Eq. S45, we can without loss of generality consider only Bell functions for which 0 ≤
IL < INS ≤ Imax, where IL is the maximum expectation of I for LR distributions. Further,
because the relevant quantities below are invariant when the Bell function is rescaled, we can
assume IL = 1. According to Ref. [2]’s Eq. 8 and the following paragraph, we can write
f(x) = − log2(g(x)), where g is monotonically decreasing and concave, and satisfies

max
ab

P(ab|xy) ≤ g(E(I)P) (S46)

for all xy and non-signaling distributions P. (Recall that we are not using the stronger constraint
that P be induced by a quantum state.) According to Eq. S15 we can define g(x) = 1 + (1 −
x)/(2(INS − 1)). Later we argue that this definition of g cannot be improved. Substituting into
Eq. S45 we get the inequality

−n log2

1 + 1− Jm + (Imax + INS)
√

2
n

ln 1
�

2(INS − 1)

 > 0. (S47)
Since 2(INS − 1) is positive, this is equivalent to√

2

n
ln

1

�
<

Jm − 1
Imax + INS

. (S48)

Noting that Imax + INS ≥ 2INS, this implies√
2

n
ln

1

�
<
Jm − 1

2INS
. (S49)

Thus, the number of trials needed to extract randomness by the PM protocol is bounded below
according to

n > 8
ln(1/�)I2NS
(Jm − 1)2

. (S50)

For a given anticipated experimental distribution Pant, Jm is best chosen to be at most E(I)Pant .
Otherwise, the probability that Ī exceeds Jm is small. However, for the maximum amount of
extractable randomness, Jm should be close to E(I)Pant . Consider the inferred distribution from
the first 5× 106 trials of Data Set 5. By following the procedure given in Section 2 of [39], we
can write this distribution as a convex combination of a PR box with weight p = 3.915× 10−4

22



and an LR distribution with weight 1 − p. From this we see that one should choose Jm ≤
E(I)Pant = pINS + (1 − p) ≤ pINS + 1. Substituting into Eq. S50 and using � ≤ 0.05 (a rather
high bound on the allowable TV distance from uniform) gives

n > 8
ln(1/�)

p2
≥ 1.56× 108, (S51)

which is already more than twice the number of trials used to generate randomness in Data
Set 5. For smaller error values comparable to the ones we report, this bound only increases:
achieving � = 10−12 would require at least 1.44× 109 trials.

To finish our argument that the PM protocol cannot improve on this bound under our as-
sumptions, consider the definition of g. If we could find a function g′ ≤ g with g′(x) < g(x)
for some x ∈ (1, INS], then f = − log2(g′) might yield a smaller lower bound on n. Note that
for x ≤ 1, g′(x) ≥ g′(1) and g′(1) must be at least 1 because, referring to Eq. S46, there is a
conditionally deterministic LR distribution P satisfying E(I)P = 1 and maxab P(ab|xy) = 1.
Hence Eq. S45 cannot be satisfied for arguments x of f(x) = − log2(g′(x)) with x ≤ 1. Given
x ∈ (1, INS], write x = (1 − p) + pINS. Let Q be the PR box achieving E(I)Q = INS and
Q′ a conditionally deterministic LR theory achieving E(I)Q′ = 1. Then E(I)(1−p)Q′+pQ′ = x.
Furthermore, there is a setting xy at which the LR theory’s outcome is inside the support of the
PR box’s outcomes. To see this, by symmetry it suffices to consider the PR box of Eq. S13. Its
outcomes are opposite at setting 11 and identical at the other three. A deterministic LR theory’s
outcomes are opposite at an even number of settings, so either it is opposite at setting 11, or it is
identical at one of the others. For setting xy, the bound in Eq. S46 is achieved for our definition
of g. Hence any other valid replacement g′ for g must satisfy g′(x) ≥ g(x) for x ∈ (1, INS], and
so Eq. S45 with f(x) = − log2(g′(x)) implies Eq. S45 with f(x) = − log2(g(x)). Thus the
lower bound on n derived above will apply to g′ as well.

References
[35] Levin, D. A., Peres, Y. & Wilmer, E. L. Markov chains and mixing times (American

Mathematical Soc., 2009).

[36] Pardo, M. & Vajda, I. About distances of discrete distributions satisfying the data process-
ing theorem of information theory. IEEE transactions on information theory 43, 1288–1293
(1997).

[37] Popescu, S. & Rohrlich, D. Quantum nonlocality as an axiom. Found. Phys. 24, 379–85
(1994).

[38] Barrrett, J. et al. Nonlocal correlations as an information-theoretic resource. Phys. Rev. A
71, 022101 (2005).

23



[39] Bierhorst, P. Geometric decompositions of Bell polytopes with practical applications. J.
Phys. A: Math. Theor. 49, 215301 (2016).

[40] Shafer, G., Shen, A., Vereshchagin, N. & Vovk, V. Test martingales, Bayes factors and
p-values. Statistical Science 26, 84–101 (2011).

[41] Vadhan, S. P. Pseudorandomness, vol. 7 of Foundations and Trends in Theoretical Com-
puter Science (2012).

[42] Ma, X., Zhang, Z. & Tan, X. Explicit combinatorial design (2012). ArXiv:1109.6147v2
[math.CO].

[43] Kessler, M. & Arnon-Friedman, R. Device-independent randomness amplification and
privatization (2017). ArXiv:1705.04148 [quant-ph].

[44] König, R. & Terhal, B. The bounded-storage model in the presence of a quantum adver-
sary. IEEE T. Inform. Theory 54, 749–62 (2008).

[45] Portmann, C. & Renner, R. Cryptographic security of quantum key distribution (2014).
ArXiv:1409.3525 [quant-ph].

[46] Bierhorst, P. et al. Experimentally generated random numbers certified by the impossibil-
ity of superluminal signaling (2017). ArXiv:1702.05178 [quant-ph].

[47] Clauser, J., Horne, A., Shimony, A. & Holt, R. Proposed experiment to test local hidden-
variable theories. Phys. Rev. Lett. 23, 880–884 (1969).

[48] Nieto-Silleras, O., Bamps, C., Silman, J. & Pironio, S. Device-independent randomness
generation from several Bell estimators (2016). ArXiv:1611.00352 [quant-ph].

24


	S.1 Preliminaries
	S.2 Proof of the Entropy Production Theorem
	S.3 Choosing the Bell Function T
	S.4 The TMPS Algorithm
	S.5 Proof of the Protocol Soundness Theorem
	S.6 Protocol Application Details
	S.7 Performance of Previous Protocols.

